<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo App | Node.JS Express.JS SQLite</title>

   
    <link rel="stylesheet" href="/fanta.css" />
   
    <link rel="stylesheet" href="/styles.css" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
    <section id="auth">
        <div>
            <!-- FIXED: className â†’ class -->
            <h2 class="sign-up-text">Login</h2>
            <p>Create an account!</p>
        </div>

        <p id="error" style="display: none; color: #ef4444; text-align: center; font-weight: 500;"></p>

        <input id="emailInput" placeholder="Email" type="email" />
        <input id="passwordInput" placeholder="********" type="password" />

        <button id="authBtn" type="button">Submit</button>

        <hr />

        <div class="register-content">
            <p>Don't have an account?</p>
            <button id="registerBtn" type="button">Sign up</button>
        </div>
    </section>

    <header style="display: none;">
        <h1 class="text-gradient">You have 0 open tasks.</h1>
    </header>

    <nav style="display: none;" class="tab-container">
        <button type="button" onclick="changeTab('All')" class="tab-button selected-tab">
            <h4>All <span>(0)</span></h4>
        </button>
        <button type="button" onclick="changeTab('Open')" class="tab-button">
            <h4>Open <span>(0)</span></h4>
        </button>
        <button type="button" onclick="changeTab('Complete')" class="tab-button">
            <h4>Complete <span>(0)</span></h4>
        </button>
        <hr />
    </nav>

    <main style="display: none;"></main>

    <script>
        let token = localStorage.getItem('token')

        let isLoading = false
        let isAuthenticating = false
        let isRegistration = false
        let selectedTab = 'All'
        let todos = []

        const apiBase = '/'

        // elements
        const nav = document.querySelector('nav')
        const header = document.querySelector('header')
        const main = document.querySelector('main')
        const navElements = document.querySelectorAll('.tab-button')
        const authContent = document.getElementById('auth')
        const error = document.getElementById('error')
        const email = document.getElementById('emailInput')
        const password = document.getElementById('passwordInput')
        const registerBtn = document.getElementById('registerBtn')
        const authBtn = document.getElementById('authBtn')

        async function showDashboard() {
            nav.style.display = 'block'
            header.style.display = 'flex'
            main.style.display = 'flex'
            authContent.style.display = 'none'

            await fetchTodos()
        }

        function updateHeaderText() {
            const openCount = todos.filter(t => !t.completed).length
            const text = openCount === 1
                ? `You have 1 open task.`
                : `You have ${openCount} open tasks.`
            header.querySelector('h1').innerText = text
        }

        function updateNavCount() {
            navElements.forEach(btn => {
                const type = btn.querySelector('h4').childNodes[0].textContent.trim()
                let count = 0
                if (type === 'All') count = todos.length
                else if (type === 'Open') count = todos.filter(t => !t.completed).length
                else count = todos.filter(t => t.completed).length

                btn.querySelector('span').innerText = `(${count})`
            })
        }

        function changeTab(tab) {
            selectedTab = tab
            navElements.forEach(btn => {
                btn.classList.toggle('selected-tab', btn.innerText.includes(tab))
            })
            renderTodos()
        }

        function renderTodos() {
            updateNavCount()
            updateHeaderText()

            let html = ''
            todos
                .filter(todo => {
                    if (selectedTab === 'All') return true
                    if (selectedTab === 'Complete') return todo.completed
                    return !todo.completed
                })
                .forEach(todo => {
                    html += `
                    <div class="card todo-item ${todo.completed ? 'todo-complete' : ''}">
                        <p>${todo.task}</p>
                        <div class="todo-buttons">
                            <button type="button" onclick="updateTodo(${todo.id})" ${todo.completed ? 'disabled' : ''}>
                                <h6>Done</h6>
                            </button>
                            <button type="button" onclick="deleteTodo(${todo.id})">
                                <h6>Delete</h6>
                            </button>
                        </div>
                    </div>`
                })

            html += `
            <div class="input-container">
                <input id="todoInput" placeholder="Add task" />
                <button type="button" onclick="addTodo()">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>`

            main.innerHTML = html
        }

        async function toggleIsRegister() {
            isRegistration = !isRegistration
            document.querySelector('#auth > div h2').innerText = isRegistration ? 'Sign Up' : 'Login'
            document.querySelector('.register-content p').innerText = isRegistration
                ? 'Already have an account?'
                : "Don't have an account?"
            registerBtn.innerText = isRegistration ? 'Sign in' : 'Sign up'
        }

        async function authenticate() {
            const emailVal = email.value.trim()
            const passVal = password.value

            if (isAuthenticating || !emailVal || !passVal || passVal.length < 6 || !emailVal.includes('@')) {
                return
            }

            error.style.display = 'none'
            isAuthenticating = true
            authBtn.innerText = 'Loading...'

            try {
                const endpoint = isRegistration ? 'auth/register' : 'auth/login'
                const res = await fetch(apiBase + endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: emailVal, password: passVal })
                })

                const data = await res.json()

                if (data.token) {
                    token = data.token
                    localStorage.setItem('token', token)
                    await fetchTodos()
                    showDashboard()
                } else {
                    throw new Error(data.message || 'Authentication failed')
                }
            } catch (err) {
                error.textContent = err.message
                error.style.display = 'block'
            } finally {
                authBtn.innerText = 'Submit'
                isAuthenticating = false
            }
        }

        async function fetchTodos() {
            isLoading = true
            try {
                const res = await fetch(apiBase + 'todos', {
                    headers: { 'Authorization': token }
                })
                todos = await res.json()
                renderTodos()
            } catch (e) {
                console.error(e)
            }
            isLoading = false
        }

        async function addTodo() {
            const input = document.getElementById('todoInput')
            const task = input.value.trim()
            if (!task) return

            await fetch(apiBase + 'todos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                },
                body: JSON.stringify({ task })
            })

            input.value = ''
            await fetchTodos()
        }

        async function updateTodo(id) {
            const todo = todos.find(t => t.id === id)
            await fetch(apiBase + 'todos/' + id, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                },
                body: JSON.stringify({ task: todo.task, completed: 1 })
            })
            await fetchTodos()
        }

        async function deleteTodo(id) {
            await fetch(apiBase + 'todos/' + id, {
                method: 'DELETE',
                headers: { 'Authorization': token }
            })
            await fetchTodos()
        }

        // Auto-login if token exists
        if (token) {
            fetchTodos().then(() => {
                if (todos !== null) showDashboard()
            })
        }
    </script>
</body>

</html>